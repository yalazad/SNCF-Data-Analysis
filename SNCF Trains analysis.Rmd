---
title: "SNCF Trains analysis"
output: html_notebook
---

```{r}
options(warn=-1)
df_raw = read.csv("full_trains.csv")
library(igraph)
library(ggraph)
library(tidyverse)
library(scales)
library(patchwork)
library(dplyr)
library(viridis)
library(hrbrthemes)
```


Select everything except comments for cancellation, departure and arrival delays
Calculate the % of late departures
Calculate the mean monthly % cancelled
```{r}
df = df_raw %>%
  select(-c(comment_cancellations,comment_delays_at_departure,comment_delays_on_arrival))

df = df %>%
  mutate(pct_late_departure = num_late_at_departure/total_num_trips,
         mean_monthly_pct_cancelled = num_of_canceled_trains/total_num_trips)  

```

```{r}
head(df)
```
Check for missing values
```{r}
na_count = data.frame(na_sum = colSums(is.na(df)))%>%
arrange(desc(na_sum))

na_count %>% 
filter(na_sum !=0)
```

Check the service variable
```{r}
df %>% 
group_by(year,service) %>% 
count()
```
No service info for 2018.
We can use the ggraph package to plot the stations network.
```{r}
p1 =  df %>% 
  filter(year != 2018) %>% 
  group_by(departure_station,arrival_station,service) %>%
  mutate(id = map2_chr(departure_station, arrival_station,
                       ~str_flatten(sort(c(.x,.y)))))%>%     # For each unique pairs of stations create an id
  group_by(id) %>%
  rename(from = departure_station,to = arrival_station)


p1 = p1[,c("from","to","service","id")] 
graph1 = graph.data.frame(p1) 



   ggraph(graph1) +
    geom_node_text(aes(label = name,color = name),size = 3)+
  geom_edge_diagonal(aes(color = service),alpha = 0.4,width = 1)+
  scale_edge_color_manual(values=c("darkcyan","burlywood"))+
  geom_node_text(aes(label = name,color = name),size = 3)+
    theme_void()+
    
    scale_colour_discrete(name  ="service",
                            breaks=c("National", "International"),
                            labels=c("National", "International"))+
    theme(legend.position="top",
          legend.background = element_rect(fill="gray90"),
        legend.text =element_text(size=14,face="bold"),
        legend.title = element_text(size=14,face="bold"))

```
There are 6 international destinations: Italy,Frankfurt,Stuttgart,Lausanne,Zurich,Geneva. The two central stations are PARIS LYON and PARIS MONTPARNASSE.

Now, let's look at the rate of delays by year for each month.

```{r}
df %>%
  mutate(pct_late_departure = num_late_at_departure/total_num_trips) %>%
  group_by(year,month) %>% 
  summarise(monthly_pct_late_departure = mean(pct_late_departure)) %>% 
  ggplot(aes(month,monthly_pct_late_departure,color = factor(year)))+
    geom_line(size = 2)+
    labs(color = "Year")+
theme(axis.text=element_text(face="bold"),
        axis.title=element_text(face="bold"),
        legend.text =element_text(face="bold"),
        legend.title = element_text(face="bold"))
```
2018 was nuts. After looking it up in google I found that during 2018 SNCF went on strike due to planned government reforms. https://www.cnbc.com/2018/04/03/france-train-strike-scnf-action-brings-travel-chaos.html

We can also learn by looking at the plot that the peak of delays occurs around June. Tourism maybe?

But that's quite a messy graph because we need to recode our year variable

```{r}
Sys.setlocale("LC_TIME", "C")
df = df %>% mutate(date = as.Date(sprintf("%d-%02d-01",year,month)))

df %>%  
  group_by(date) %>% 
  summarise(mean_monthly_pct_late_departure = mean(pct_late_departure)) %>% 
  ggplot(aes(date,mean_monthly_pct_late_departure,size = 1))+
  theme_classic()+
  xlab("Year")+
  geom_line(size = 1)+
theme(axis.text=element_text(size=14,face="bold"),
        axis.title=element_text(size=14,face="bold"),
        legend.text =element_text(size=14,face="bold"),
        legend.title = element_text(size=14,face="bold"))
```
Let's compare cancellations and delays
```{r}
p3 = df %>% 
  group_by(year,date) %>% 
  summarise(delays_rate = mean(pct_late_departure)) %>% 
  ungroup() %>% 
  ggplot(aes(date,delays_rate,fill=delays_rate))+
  scale_fill_gradient(low="pink", high="red")+
  scale_y_continuous(labels = percent_format())+
  geom_bar(stat = "identity")+
theme(axis.text=element_text(size=16,face="bold"),
        axis.title=element_text(size=16,face="bold"),
        legend.text =element_text(size=16,face="bold"),
        legend.title = element_text(size=16,face="bold"))



p4 = df %>%
  group_by(year,date) %>% 
  summarise(cancelltions_rate = mean(mean_monthly_pct_cancelled)) %>% 
  ggplot(aes(date,cancelltions_rate,fill=cancelltions_rate))+
  scale_fill_gradient(low="pink", high="red")+
  scale_y_continuous(labels = percent_format())+
  geom_bar(stat = "identity")+
theme(axis.text=element_text(size=16,face="bold"),
        axis.title=element_text(size=16,face="bold"),
        legend.text =element_text(size=16,face="bold"),
        legend.title = element_text(size=16,face="bold"))

p3/p4
```
So when the rate of delays went down cancellations went up in 2018
Do busy stations (=more circulating trains) tend to have delays more often than not?

```{r}
df %>% 
  group_by(departure_station) %>% 
  summarise(Avg_pct_departure_station_late = mean(pct_late_departure),
            Avg_circulating_trains = mean(total_num_trips)) %>% 
  arrange(desc(Avg_pct_departure_station_late)) %>% 
  filter(Avg_pct_departure_station_late>0.1) %>% 
  ggplot(aes(x = reorder(departure_station, -Avg_pct_departure_station_late,order = F), y= Avg_pct_departure_station_late,fill= Avg_circulating_trains))+
  scale_fill_gradient(low='pink', high='red')+
  geom_bar(stat = "identity")+
  coord_flip()

```
How do the causes of delay fluctuate over time?
```{r}
df %>%  
  group_by(year,month) %>% 
        summarise(across(starts_with("delay_"), mean,na.rm = T)) %>%  
         mutate(date = as.Date(sprintf("%d-%02d-01",year,month))) %>% 
        pivot_longer(cols = starts_with("delay"),names_to = "delay") %>%
        mutate(delay = substring(delay,nchar("delay_cause_")+1)) %>% 
        rename(delay_cause = delay) %>% 
  ggplot(aes(date,value,fill = delay_cause))+
  scale_fill_viridis(discrete = T)+
  geom_area(alpha = 0.6)+
  scale_y_continuous(labels = percent_format())+
theme(axis.text=element_text(size=14,face="bold"),
        axis.title=element_text(size=14,face="bold"),
        legend.text =element_text(size=14,face="bold"),
        legend.title = element_text(size=14,face="bold"))
```
Group by service
```{r}
df %>%  
  filter(year != 2018) %>% 
  group_by(year,month,service) %>% 
        summarise(across(starts_with("delay_"), mean,na.rm = T)) %>% 
         mutate(date = as.Date(sprintf("%d-%02d-01",year,month))) %>% 
        pivot_longer(cols = starts_with("delay"),names_to = "delay") %>%
        mutate(delay = substring(delay,nchar("delay_cause_")+1)) %>% 
        rename(delay_cause = delay) %>% 
  ggplot(aes(date,value,fill = delay_cause))+
  scale_fill_viridis(discrete = T)+
  facet_grid(~service) +
  geom_area(alpha = 0.7)+
  scale_y_continuous(labels = percent_format())+
theme(axis.text=element_text(size=14,face="bold"),
        axis.title=element_text(size=14,face="bold"),
        legend.text =element_text(size=14,face="bold"),
        legend.title = element_text(size=14,face="bold"),
     strip.text = element_text(face="bold", size=14))
```

